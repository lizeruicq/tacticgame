# å¾®ä¿¡å°æ¸¸æˆäº‘å¼€å‘é›†æˆå®Œæ•´æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æŒ‡å—æä¾›å¾®ä¿¡å°æ¸¸æˆä¸äº‘å¼€å‘çš„å®Œæ•´é›†æˆæ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š
- ç©å®¶è´¦æˆ·ç³»ç»Ÿï¼ˆåŸºäº openidï¼‰
- äº‘ç«¯æ•°æ®å­˜å‚¨ï¼ˆplayers å’Œ gameData é›†åˆï¼‰
- 6 ä¸ªäº‘å‡½æ•°æ¥å£
- å‰ç«¯é›†æˆä»£ç ï¼ˆCloudDatabaseManagerï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ80 åˆ†é’Ÿï¼‰

### ç¬¬ 1 æ­¥ï¼šäº‘å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆ5 åˆ†é’Ÿï¼‰

1. ç™»å½•å¾®ä¿¡å°æ¸¸æˆåå°
2. è¿›å…¥ **å¼€å‘** â†’ **äº‘å¼€å‘**
3. ç‚¹å‡» **å¼€é€šäº‘å¼€å‘**
4. åˆ›å»ºç¯å¢ƒï¼Œ**è®°å½•ç¯å¢ƒ ID**ï¼ˆå¦‚ï¼š`cloud1-8g8n4rwc79d64d40`ï¼‰

### ç¬¬ 2 æ­¥ï¼šåˆ›å»ºæ•°æ®åº“é›†åˆï¼ˆ10 åˆ†é’Ÿï¼‰

**é›†åˆ 1ï¼šplayersï¼ˆç©å®¶ä¿¡æ¯ï¼‰**
- è¿›å…¥ **æ•°æ®åº“** â†’ æ–°å»ºé›†åˆï¼š`players`
- åœ¨ `openid` å­—æ®µåˆ›å»º **å”¯ä¸€ç´¢å¼•**
- è®¾ç½®æƒé™ï¼šä»…åˆ›å»ºè€…å¯å†™

**é›†åˆ 2ï¼šgameDataï¼ˆæ¸¸æˆæ•°æ®ï¼‰**
- æ–°å»ºé›†åˆï¼š`gameData`
- åœ¨ `openid` å­—æ®µåˆ›å»º **ç´¢å¼•**
- è®¾ç½®æƒé™ï¼šä»…åˆ›å»ºè€…å¯è¯»å†™

### ç¬¬ 3 æ­¥ï¼šåˆ›å»º 6 ä¸ªäº‘å‡½æ•°ï¼ˆ20 åˆ†é’Ÿï¼‰

åœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ **äº‘å‡½æ•°** â†’ **æ–°å»ºäº‘å‡½æ•°**ï¼Œåˆ›å»ºä»¥ä¸‹å‡½æ•°ï¼š

#### 1. login äº‘å‡½æ•°

```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext();
  return {
    openid: wxContext.OPENID,
    appid: wxContext.APPID,
    unionid: wxContext.UNIONID,
  };
};
```

#### 2. savePlayerInfo äº‘å‡½æ•°

```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  try {
    const { openid, nickName, avatarUrl, gender, city, province, country, language } = event;
    
    const existingPlayer = await db.collection('players').where({ openid }).get();
    
    if (existingPlayer.data.length > 0) {
      await db.collection('players').doc(existingPlayer.data[0]._id).update({
        data: { nickName, avatarUrl, gender, city, province, country, language, updatedAt: db.serverDate() }
      });
    } else {
      await db.collection('players').add({
        data: { openid, nickName, avatarUrl, gender, city, province, country, language, createdAt: db.serverDate() }
      });
    }
    
    return { code: 0, message: 'ä¿å­˜æˆåŠŸ', data: { openid } };
  } catch (error) {
    return { code: 1, message: error.message };
  }
};
```

#### 3. getPlayerInfo äº‘å‡½æ•°

```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  try {
    const { openid } = event;
    const result = await db.collection('players').where({ openid }).get();
    
    if (result.data.length > 0) {
      return { code: 0, message: 'è·å–æˆåŠŸ', data: result.data[0] };
    } else {
      return { code: 1, message: 'ç©å®¶ä¸å­˜åœ¨' };
    }
  } catch (error) {
    return { code: 1, message: error.message };
  }
};
```

#### 4. updateGameData äº‘å‡½æ•°

```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  try {
    const { openid, gameData } = event;
    
    const existingData = await db.collection('gameData').where({ openid }).get();
    
    if (existingData.data.length > 0) {
      await db.collection('gameData').doc(existingData.data[0]._id).update({
        data: { ...gameData, updatedAt: db.serverDate() }
      });
    } else {
      await db.collection('gameData').add({
        data: { openid, ...gameData, createdAt: db.serverDate() }
      });
    }
    
    return { code: 0, message: 'æ›´æ–°æˆåŠŸ', data: { openid } };
  } catch (error) {
    return { code: 1, message: error.message };
  }
};
```

#### 5. getGameData äº‘å‡½æ•°

```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  try {
    const { openid } = event;
    const result = await db.collection('gameData').where({ openid }).get();
    
    if (result.data.length > 0) {
      return { code: 0, message: 'è·å–æˆåŠŸ', data: result.data[0] };
    } else {
      return { code: 1, message: 'æ¸¸æˆæ•°æ®ä¸å­˜åœ¨' };
    }
  } catch (error) {
    return { code: 1, message: error.message };
  }
};
```

#### 6. checkPlayerExists äº‘å‡½æ•°

```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  try {
    const { openid } = event;
    const result = await db.collection('players').where({ openid }).get();
    
    if (result.data.length > 0) {
      return { code: 0, message: 'ç©å®¶å­˜åœ¨', data: { exists: true, playerInfo: result.data[0] } };
    } else {
      return { code: 0, message: 'ç©å®¶ä¸å­˜åœ¨', data: { exists: false, playerInfo: null } };
    }
  } catch (error) {
    return { code: 1, message: error.message };
  }
};
```

### ç¬¬ 4 æ­¥ï¼šå‰ç«¯é›†æˆï¼ˆ20 åˆ†é’Ÿï¼‰

#### æ›´æ–°ç¯å¢ƒ ID

åœ¨ `src/utils/CloudDatabaseManager.ts` ä¸­ï¼Œå°†ç¯å¢ƒ ID æ›¿æ¢ä¸ºä½ çš„ï¼š

```typescript
private static readonly CLOUD_ENV_ID = 'cloud1-ä½ çš„ç¯å¢ƒID';
```

#### ä¿®æ”¹ GameDataManager.ts

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

```typescript
import { CloudDatabaseManager } from './utils/CloudDatabaseManager';
```

åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ï¼š

```typescript
private cloudDatabaseManager: CloudDatabaseManager;
private playerOpenid: string = '';

private constructor() {
    this.cloudDatabaseManager = CloudDatabaseManager.getInstance();
    // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
}
```

ä¿®æ”¹ `initializeData` æ–¹æ³•ï¼š

```typescript
private async initializeData() {
    try {
        // è·å– openid
        this.playerOpenid = await this.cloudDatabaseManager.getOpenid();
        
        // æ£€æŸ¥ç©å®¶æ˜¯å¦å­˜åœ¨
        const playerCheck = await this.cloudDatabaseManager.checkPlayerExists(this.playerOpenid);
        
        if (playerCheck.exists) {
            // è€ç©å®¶ï¼šä»äº‘å¼€å‘åŠ è½½æ•°æ®
            const playerInfo = await this.cloudDatabaseManager.getPlayerInfo(this.playerOpenid);
            const gameData = await this.cloudDatabaseManager.getGameData(this.playerOpenid);
            this.playerData = gameData || this.getDefaultPlayerData();
        } else {
            // æ–°ç©å®¶ï¼šåˆå§‹åŒ–æ•°æ®
            const userInfo = await this.weChatManager.getUserInfo();
            await this.cloudDatabaseManager.savePlayerInfo({
                openid: this.playerOpenid,
                nickName: userInfo.nickName,
                avatarUrl: userInfo.avatarUrl,
                gender: userInfo.gender,
                city: userInfo.city,
                province: userInfo.province,
                country: userInfo.country,
                language: userInfo.language
            });
            this.playerData = this.getDefaultPlayerData();
            await this.cloudDatabaseManager.updateGameData(this.playerOpenid, this.playerData);
        }
    } catch (error) {
        console.error('åˆå§‹åŒ–æ•°æ®å¤±è´¥:', error);
        this.playerData = this.getDefaultPlayerData();
    }
}
```

ä¿®æ”¹ `saveGameData` æ–¹æ³•ï¼š

```typescript
public async saveGameData() {
    try {
        // ä¿å­˜åˆ°æœ¬åœ°
        const gameDataStr = JSON.stringify(this.playerData);
        wx.setStorageSync(GameDataManager.GAME_DATA_KEY, gameDataStr);
        
        // åŒæ­¥åˆ°äº‘å¼€å‘
        if (this.playerOpenid) {
            await this.cloudDatabaseManager.updateGameData(this.playerOpenid, this.playerData);
        }
    } catch (error) {
        console.error('ä¿å­˜æ¸¸æˆæ•°æ®å¤±è´¥:', error);
    }
}
```

### ç¬¬ 5 æ­¥ï¼šæµ‹è¯•ï¼ˆ10 åˆ†é’Ÿï¼‰

#### æµ‹è¯• 1ï¼šæ–°ç©å®¶é¦–æ¬¡ç™»å½•
- æ¸…é™¤æœ¬åœ°å­˜å‚¨
- å¯åŠ¨æ¸¸æˆ
- æ£€æŸ¥äº‘å¼€å‘æ§åˆ¶å°ï¼ŒéªŒè¯ players å’Œ gameData é›†åˆä¸­æœ‰æ–°è®°å½•

#### æµ‹è¯• 2ï¼šè€ç©å®¶å†æ¬¡ç™»å½•
- é‡æ–°å¯åŠ¨æ¸¸æˆ
- éªŒè¯ç©å®¶ä¿¡æ¯å’Œæ¸¸æˆæ•°æ®æ­£ç¡®åŠ è½½

#### æµ‹è¯• 3ï¼šæ•°æ®åŒæ­¥
- åœ¨æ¸¸æˆä¸­å‡çº§æˆ–è·å¾—é‡‘å¸
- éªŒè¯æœ¬åœ°å­˜å‚¨å’Œäº‘å¼€å‘éƒ½å·²æ›´æ–°

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
å‰ç«¯ï¼ˆGameDataManager + CloudDatabaseManagerï¼‰
         â†“
    äº‘å‡½æ•°ï¼ˆ6 ä¸ªï¼‰
         â†“
    æ•°æ®åº“ï¼ˆ2 ä¸ªé›†åˆï¼‰
```

### æ–°ç©å®¶ç™»å½•æµç¨‹

```
æ¸¸æˆå¯åŠ¨ â†’ è·å– openid â†’ æ£€æŸ¥ç©å®¶æ˜¯å¦å­˜åœ¨
  â†“
ç©å®¶ä¸å­˜åœ¨ â†’ è·å–å¾®ä¿¡ä¿¡æ¯ â†’ ä¿å­˜åˆ°äº‘å¼€å‘ â†’ åˆå§‹åŒ–æ¸¸æˆæ•°æ® â†’ è¿›å…¥æ¸¸æˆ
```

### è€ç©å®¶ç™»å½•æµç¨‹

```
æ¸¸æˆå¯åŠ¨ â†’ è·å– openid â†’ æ£€æŸ¥ç©å®¶æ˜¯å¦å­˜åœ¨
  â†“
ç©å®¶å­˜åœ¨ â†’ ä»äº‘å¼€å‘åŠ è½½ç©å®¶ä¿¡æ¯ â†’ ä»äº‘å¼€å‘åŠ è½½æ¸¸æˆæ•°æ® â†’ è¿›å…¥æ¸¸æˆ
```

## ğŸ› å¸¸è§é—®é¢˜

### Q: äº‘å‡½æ•°è°ƒç”¨å¤±è´¥
A: æ£€æŸ¥ï¼š
1. ç¯å¢ƒ ID æ˜¯å¦æ­£ç¡®
2. äº‘å‡½æ•°æ˜¯å¦å·²éƒ¨ç½²
3. æ•°æ®åº“æƒé™æ˜¯å¦è®¾ç½®æ­£ç¡®
4. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

### Q: æ•°æ®æ— æ³•ä¿å­˜åˆ°äº‘å¼€å‘
A: æ£€æŸ¥ï¼š
1. æ•°æ®åº“é›†åˆæ˜¯å¦å·²åˆ›å»º
2. æƒé™è®¾ç½®æ˜¯å¦æ­£ç¡®ï¼ˆåº”ä¸º"ä»…åˆ›å»ºè€…å¯å†™"ï¼‰
3. äº‘å‡½æ•°ä»£ç æ˜¯å¦æ­£ç¡®

### Q: å¦‚ä½•ç¦»çº¿è¿è¡Œæ¸¸æˆ
A: æ¸¸æˆä¼šè‡ªåŠ¨ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„æ•°æ®ã€‚å½“ç½‘ç»œæ¢å¤æ—¶ï¼Œä¼šè‡ªåŠ¨åŒæ­¥åˆ°äº‘å¼€å‘ã€‚

### Q: å¦‚ä½•å¤„ç†ç½‘ç»œé”™è¯¯
A: CloudDatabaseManager å·²åŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†ã€‚å¦‚æœäº‘å‡½æ•°è°ƒç”¨å¤±è´¥ï¼Œæ¸¸æˆä¼šç»§ç»­ä½¿ç”¨æœ¬åœ°æ•°æ®ã€‚

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] å¯ç”¨äº‘å¼€å‘
- [ ] åˆ›å»º players é›†åˆ
- [ ] åˆ›å»º gameData é›†åˆ
- [ ] åˆ›å»º 6 ä¸ªäº‘å‡½æ•°
- [ ] éƒ¨ç½²æ‰€æœ‰äº‘å‡½æ•°
- [ ] æ›´æ–°ç¯å¢ƒ ID
- [ ] ä¿®æ”¹ GameDataManager.ts
- [ ] æµ‹è¯•æ–°ç©å®¶ç™»å½•
- [ ] æµ‹è¯•è€ç©å®¶ç™»å½•
- [ ] æµ‹è¯•æ•°æ®åŒæ­¥

## ğŸ“š æ–‡ä»¶æ¸…å•

- âœ… `src/utils/CloudDatabaseManager.ts` - äº‘å¼€å‘ç®¡ç†å™¨ç±»
- âœ… `src/GameDataManager.ts` - éœ€è¦ä¿®æ”¹ï¼ˆå‚è€ƒä¸Šé¢çš„ä»£ç ï¼‰

## ğŸ‰ å®Œæˆæ ‡å¿—

âœ… æ–°ç©å®¶é¦–æ¬¡ç™»å½•æ—¶ï¼Œæ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°äº‘å¼€å‘
âœ… è€ç©å®¶å†æ¬¡ç™»å½•æ—¶ï¼Œæ•°æ®è‡ªåŠ¨ä»äº‘å¼€å‘åŠ è½½
âœ… æ¸¸æˆè¿‡ç¨‹ä¸­ï¼Œæ•°æ®å®šæœŸåŒæ­¥åˆ°äº‘å¼€å‘
âœ… äº‘å¼€å‘æ§åˆ¶å°ä¸­å¯ä»¥çœ‹åˆ°ç©å®¶æ•°æ®
âœ… æ¸¸æˆå¯ä»¥ç¦»çº¿è¿è¡Œï¼ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼‰
âœ… é”™è¯¯å¤„ç†å®Œå–„ï¼Œæ¸¸æˆä¸ä¼šå› ä¸ºç½‘ç»œé—®é¢˜è€Œå´©æºƒ

---

**ç¥ä½ çš„å¾®ä¿¡å°æ¸¸æˆäº‘å¼€å‘é›†æˆé¡ºåˆ©ï¼** ğŸ®âœ¨

