# å¾®ä¿¡å°æ¸¸æˆæ‰“åŒ…å’Œäº‘å‡½æ•°éƒ¨ç½²å®Œæ•´æŒ‡å—

## ğŸ“‹ æ•´ä½“æµç¨‹

```
Laya é¡¹ç›®ï¼ˆæºä»£ç ï¼‰
    â†“
1. åœ¨ Laya ä¸­æ„å»ºé¡¹ç›®
    â†“
2. ç”Ÿæˆå¾®ä¿¡å°ç¨‹åºé¡¹ç›®ï¼ˆåœ¨ /Desktop/theRockWarï¼‰
    â†“
3. åœ¨å¾®ä¿¡å°ç¨‹åºé¡¹ç›®ä¸­åˆ›å»º cloudfunctions ç›®å½•
    â†“
4. æ·»åŠ  project.config.json é…ç½®
    â†“
5. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ‰“å¼€é¡¹ç›®
    â†“
6. ä¸Šä¼ å¹¶éƒ¨ç½²äº‘å‡½æ•°
    â†“
å®Œæˆï¼
```

---

## ğŸ”§ ç¬¬ 1 æ­¥ï¼šåœ¨ Laya ä¸­æ„å»ºé¡¹ç›®

### 1.1 æ‰“å¼€ Laya IDE

åœ¨ä½ çš„ Laya é¡¹ç›®ä¸­ï¼š
- èœå• â†’ **é¡¹ç›®** â†’ **æ„å»ºé¡¹ç›®**
- æˆ–å¿«æ·é”®ï¼š`Ctrl+B`ï¼ˆWindowsï¼‰/ `Cmd+B`ï¼ˆMacï¼‰

### 1.2 é€‰æ‹©æ„å»ºç›®æ ‡

- é€‰æ‹© **å¾®ä¿¡å°æ¸¸æˆ** ä½œä¸ºæ„å»ºç›®æ ‡
- ç‚¹å‡» **æ„å»º**

### 1.3 æ„å»ºå®Œæˆ

æ„å»ºå®Œæˆåï¼Œä¼šåœ¨ `/Desktop/theRockWar` ç›®å½•ç”Ÿæˆå¾®ä¿¡å°ç¨‹åºé¡¹ç›®ï¼š

```
/Desktop/theRockWar/
â”œâ”€â”€ miniprogram/          â† æ¸¸æˆä»£ç ï¼ˆLaya æ‰“åŒ…åï¼‰
â”‚   â”œâ”€â”€ game.js
â”‚   â”œâ”€â”€ game.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ project.config.json   â† é¡¹ç›®é…ç½®æ–‡ä»¶
â””â”€â”€ ...
```

---

## ğŸ“ ç¬¬ 2 æ­¥ï¼šåˆ›å»º cloudfunctions ç›®å½•

### 2.1 åœ¨å¾®ä¿¡å°ç¨‹åºé¡¹ç›®ä¸­åˆ›å»ºç›®å½•

åœ¨ `/Desktop/theRockWar/` ç›®å½•ä¸‹åˆ›å»º `cloudfunctions` æ–‡ä»¶å¤¹ï¼š

```
/Desktop/theRockWar/
â”œâ”€â”€ cloudfunctions/       â† æ–°å»ºè¿™ä¸ªç›®å½•
â”‚   â”œâ”€â”€ login/
â”‚   â”œâ”€â”€ savePlayerInfo/
â”‚   â”œâ”€â”€ getPlayerInfo/
â”‚   â”œâ”€â”€ updateGameData/
â”‚   â”œâ”€â”€ getGameData/
â”‚   â””â”€â”€ checkPlayerExists/
â”œâ”€â”€ miniprogram/
â”œâ”€â”€ project.config.json
â””â”€â”€ ...
```

### 2.2 åˆ›å»ºæ¯ä¸ªäº‘å‡½æ•°çš„ç›®å½•å’Œæ–‡ä»¶

å¯¹äºæ¯ä¸ªäº‘å‡½æ•°ï¼Œåˆ›å»ºä»¥ä¸‹ç»“æ„ï¼š

```
cloudfunctions/
â”œâ”€â”€ login/
â”‚   â”œâ”€â”€ index.js          â† äº‘å‡½æ•°ä»£ç 
â”‚   â””â”€â”€ package.json      â† ä¾èµ–é…ç½®ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ savePlayerInfo/
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ package.json
â””â”€â”€ ...
```

---

## ğŸ’» ç¬¬ 3 æ­¥ï¼šç¼–å†™äº‘å‡½æ•°ä»£ç 

### 3.1 login äº‘å‡½æ•°

**æ–‡ä»¶ï¼š** `/Desktop/theRockWar/cloudfunctions/login/index.js`

```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext();
  return {
    openid: wxContext.OPENID,
    appid: wxContext.APPID,
    unionid: wxContext.UNIONID,
  };
};
```

### 3.2 savePlayerInfo äº‘å‡½æ•°

**æ–‡ä»¶ï¼š** `/Desktop/theRockWar/cloudfunctions/savePlayerInfo/index.js`

```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  try {
    const { openid, nickName, avatarUrl, gender, city, province, country, language } = event;
    
    const existingPlayer = await db.collection('players').where({ openid }).get();
    
    if (existingPlayer.data.length > 0) {
      await db.collection('players').doc(existingPlayer.data[0]._id).update({
        data: { nickName, avatarUrl, gender, city, province, country, language, updatedAt: db.serverDate() }
      });
    } else {
      await db.collection('players').add({
        data: { openid, nickName, avatarUrl, gender, city, province, country, language, createdAt: db.serverDate() }
      });
    }
    
    return { code: 0, message: 'ä¿å­˜æˆåŠŸ', data: { openid } };
  } catch (error) {
    return { code: 1, message: error.message };
  }
};
```

### 3.3 å…¶ä»–äº‘å‡½æ•°

ç±»ä¼¼åœ°åˆ›å»ºå…¶ä»– 4 ä¸ªäº‘å‡½æ•°çš„ `index.js` æ–‡ä»¶ã€‚

---

## âš™ï¸ ç¬¬ 4 æ­¥ï¼šä¿®æ”¹ project.config.json

### 4.1 æ‰“å¼€é…ç½®æ–‡ä»¶

ç¼–è¾‘ `/Desktop/theRockWar/project.config.json`

### 4.2 æ·»åŠ  cloudfunctionRoot å­—æ®µ

```json
{
  "miniprogramRoot": "miniprogram/",
  "cloudfunctionRoot": "cloudfunctions/",
  "appid": "wx15a49d22b71a7b23",
  "projectname": "theRockWar",
  ...
}
```

**å…³é”®å­—æ®µï¼š**
- `miniprogramRoot`: å°ç¨‹åºä»£ç ç›®å½•ï¼ˆé€šå¸¸æ˜¯ `miniprogram/`ï¼‰
- `cloudfunctionRoot`: äº‘å‡½æ•°ç›®å½•ï¼ˆé€šå¸¸æ˜¯ `cloudfunctions/`ï¼‰

---

## ğŸ”Œ ç¬¬ 5 æ­¥ï¼šåœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ‰“å¼€é¡¹ç›®

### 5.1 æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·

1. å¯åŠ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. ç‚¹å‡» **å¯¼å…¥é¡¹ç›®**
3. é€‰æ‹© `/Desktop/theRockWar/` ç›®å½•
4. ç‚¹å‡» **å¯¼å…¥**

### 5.2 éªŒè¯é¡¹ç›®ç»“æ„

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·çš„å·¦ä¾§é¢æ¿ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š
- **miniprogram** æ–‡ä»¶å¤¹ï¼ˆæ¸¸æˆä»£ç ï¼‰
- **cloudfunctions** æ–‡ä»¶å¤¹ï¼ˆäº‘å‡½æ•°ä»£ç ï¼‰

---

## ğŸš€ ç¬¬ 6 æ­¥ï¼šä¸Šä¼ å¹¶éƒ¨ç½²äº‘å‡½æ•°

### 6.1 ä¸Šä¼ äº‘å‡½æ•°

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
1. å³é”®ç‚¹å‡» **cloudfunctions** æ–‡ä»¶å¤¹
2. é€‰æ‹© **ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–**
3. ç­‰å¾…ä¸Šä¼ å®Œæˆ

### 6.2 éªŒè¯éƒ¨ç½²

åœ¨å¾®ä¿¡äº‘å¼€å‘æ§åˆ¶å°ï¼š
1. è¿›å…¥ **äº‘å‡½æ•°**
2. åº”è¯¥èƒ½çœ‹åˆ° 6 ä¸ªäº‘å‡½æ•°å·²éƒ¨ç½²ï¼š
   - login
   - savePlayerInfo
   - getPlayerInfo
   - updateGameData
   - getGameData
   - checkPlayerExists

---

## ğŸ“ ç¬¬ 7 æ­¥ï¼šé…ç½®äº‘å¼€å‘ç¯å¢ƒ ID

### 7.1 è·å–ç¯å¢ƒ ID

åœ¨å¾®ä¿¡äº‘å¼€å‘æ§åˆ¶å°ï¼š
1. è¿›å…¥ **ç¯å¢ƒ**
2. å¤åˆ¶ç¯å¢ƒ IDï¼ˆå¦‚ï¼š`cloud1-8g8n4rwc79d64d40`ï¼‰

### 7.2 æ›´æ–°å‰ç«¯ä»£ç 

åœ¨ Laya é¡¹ç›®ä¸­ï¼Œä¿®æ”¹ `src/utils/CloudDatabaseManager.ts`ï¼š

```typescript
// æ·»åŠ ç¯å¢ƒ ID é…ç½®
private static readonly CLOUD_ENV_ID = 'cloud1-ä½ çš„ç¯å¢ƒID';

// åˆå§‹åŒ–äº‘å¼€å‘
public static init(): void {
    if (typeof wx !== 'undefined' && wx.cloud) {
        wx.cloud.init({ env: CloudDatabaseManager.CLOUD_ENV_ID });
    }
}
```

---

## ğŸ”„ ç¬¬ 8 æ­¥ï¼šé‡æ–°æ„å»ºå’Œæµ‹è¯•

### 8.1 é‡æ–°æ„å»º Laya é¡¹ç›®

- åœ¨ Laya ä¸­ä¿®æ”¹ä»£ç åï¼Œé‡æ–°æ„å»ºé¡¹ç›®
- æ„å»ºä¼šè¦†ç›– `/Desktop/theRockWar/miniprogram/` ç›®å½•
- **ä½†ä¸ä¼šè¦†ç›– `cloudfunctions/` ç›®å½•**

### 8.2 åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æµ‹è¯•

1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­åˆ·æ–°é¡¹ç›®
2. åœ¨æ¨¡æ‹Ÿå™¨ä¸­æµ‹è¯•æ¸¸æˆ
3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼ŒéªŒè¯äº‘å‡½æ•°è°ƒç”¨æ˜¯å¦æˆåŠŸ

---

## âš ï¸ é‡è¦æç¤º

### ä¿æŠ¤äº‘å‡½æ•°ä»£ç 

æ¯æ¬¡ä» Laya é‡æ–°æ„å»ºæ—¶ï¼Œåªæœ‰ `miniprogram/` ç›®å½•ä¼šè¢«è¦†ç›–ï¼Œ`cloudfunctions/` ç›®å½•ä¸ä¼šè¢«åˆ é™¤ã€‚

**ä½†ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå»ºè®®ï¼š**

1. **åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ç®¡ç†äº‘å‡½æ•°**
   - ä¸è¦åœ¨ Laya é¡¹ç›®ä¸­ä¿å­˜äº‘å‡½æ•°ä»£ç 
   - äº‘å‡½æ•°ä»£ç åªåœ¨å¾®ä¿¡å°ç¨‹åºé¡¹ç›®ä¸­ç»´æŠ¤

2. **æˆ–è€…åœ¨ Laya é¡¹ç›®ä¸­åˆ›å»ºå¤‡ä»½**
   ```
   Laya é¡¹ç›®/
   â”œâ”€â”€ cloudfunctions-backup/    â† äº‘å‡½æ•°ä»£ç å¤‡ä»½
   â”‚   â”œâ”€â”€ login/
   â”‚   â”œâ”€â”€ savePlayerInfo/
   â”‚   â””â”€â”€ ...
   â””â”€â”€ ...
   ```

---

## ğŸ“Š å®Œæ•´çš„ç›®å½•ç»“æ„

### Laya é¡¹ç›®ï¼ˆæºä»£ç ï¼‰

```
/Users/zeruili/projects/layaprojects/therockwar-wechat/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ CloudDatabaseManager.ts    â† å‰ç«¯è°ƒç”¨äº‘å‡½æ•°
â”‚   â””â”€â”€ ...
â”œâ”€â”€ settings/
â”‚   â””â”€â”€ BuildSettings.json
â””â”€â”€ ...
```

### å¾®ä¿¡å°ç¨‹åºé¡¹ç›®ï¼ˆæ‰“åŒ…åï¼‰

```
/Desktop/theRockWar/
â”œâ”€â”€ cloudfunctions/                    â† äº‘å‡½æ•°ä»£ç 
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ savePlayerInfo/
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ getPlayerInfo/
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ updateGameData/
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ getGameData/
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â””â”€â”€ checkPlayerExists/
â”‚       â””â”€â”€ index.js
â”œâ”€â”€ miniprogram/                       â† æ¸¸æˆä»£ç ï¼ˆLaya æ‰“åŒ…ï¼‰
â”‚   â”œâ”€â”€ game.js
â”‚   â”œâ”€â”€ game.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ project.config.json                â† é¡¹ç›®é…ç½®
â””â”€â”€ ...
```

---

## âœ… æ£€æŸ¥æ¸…å•

- [ ] åœ¨ Laya ä¸­æ„å»ºé¡¹ç›®
- [ ] åœ¨ `/Desktop/theRockWar/` ä¸­åˆ›å»º `cloudfunctions` ç›®å½•
- [ ] åˆ›å»º 6 ä¸ªäº‘å‡½æ•°çš„ç›®å½•å’Œ `index.js` æ–‡ä»¶
- [ ] ç¼–å†™æ‰€æœ‰äº‘å‡½æ•°ä»£ç 
- [ ] ä¿®æ”¹ `project.config.json`ï¼Œæ·»åŠ  `cloudfunctionRoot` å­—æ®µ
- [ ] åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ‰“å¼€é¡¹ç›®
- [ ] ä¸Šä¼ å¹¶éƒ¨ç½²äº‘å‡½æ•°
- [ ] è·å–äº‘å¼€å‘ç¯å¢ƒ ID
- [ ] æ›´æ–° `CloudDatabaseManager.ts` ä¸­çš„ç¯å¢ƒ ID
- [ ] é‡æ–°æ„å»º Laya é¡¹ç›®
- [ ] åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æµ‹è¯•

---

## ğŸ‰ æ€»ç»“

| æ­¥éª¤ | ä½ç½® | æ“ä½œ |
|------|------|------|
| 1 | Laya IDE | æ„å»ºé¡¹ç›® |
| 2 | `/Desktop/theRockWar/` | åˆ›å»º `cloudfunctions` ç›®å½• |
| 3 | `cloudfunctions/` | ç¼–å†™äº‘å‡½æ•°ä»£ç  |
| 4 | `project.config.json` | æ·»åŠ  `cloudfunctionRoot` å­—æ®µ |
| 5 | å¾®ä¿¡å¼€å‘è€…å·¥å…· | æ‰“å¼€é¡¹ç›® |
| 6 | å¾®ä¿¡å¼€å‘è€…å·¥å…· | ä¸Šä¼ å¹¶éƒ¨ç½²äº‘å‡½æ•° |
| 7 | `CloudDatabaseManager.ts` | é…ç½®ç¯å¢ƒ ID |
| 8 | Laya IDE | é‡æ–°æ„å»ºé¡¹ç›® |

**ç°åœ¨ä½ å¯ä»¥å¼€å§‹åˆ›å»ºäº‘å‡½æ•°äº†ï¼** ğŸš€

