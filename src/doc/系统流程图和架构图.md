# 《石头人保卫战》系统流程图和架构图

**文档版本：** 1.0  
**编写日期：** 2026年1月11日  

---

## 目录

1. [系统架构图](#系统架构图)
2. [业务流程图](#业务流程图)
3. [数据流图](#数据流图)
4. [类关系图](#类关系图)
5. [状态转移图](#状态转移图)

---

## 系统架构图

### 1.1 整体系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户界面层 (UI Layer)                     │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐  │
│  │ LoadingScreen│ MainMenuScene│ LevelSelect  │ GameScene    │  │
│  │ (加载屏幕)   │ (主菜单)     │ (关卡选择)   │ (游戏战斗)   │  │
│  └──────────────┴──────────────┴──────────────┴──────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    业务逻辑层 (Business Logic Layer)              │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐  │
│  │ GameMainMgr  │ CardManager  │ MonsterMgr   │ PlayerMgr    │  │
│  │ (游戏主管理) │ (卡牌管理)   │ (怪物管理)   │ (玩家管理)   │  │
│  ├──────────────┼──────────────┼──────────────┼──────────────┤  │
│  │ EnemyAIMgr   │ UIManager    │ SceneManager │ SoundManager │  │
│  │ (AI管理)     │ (UI管理)     │ (场景管理)   │ (音效管理)   │  │
│  └──────────────┴──────────────┴──────────────┴──────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    数据管理层 (Data Management Layer)             │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐  │
│  │ GameDataMgr  │ WeChatMgr    │ CloudDBMgr   │ CloudResLoader
│  │ (游戏数据)   │ (微信管理)   │ (云数据库)   │ (云资源加载) │  │
│  └──────────────┴──────────────┴──────────────┴──────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                  外部服务层 (External Service Layer)              │
│  ┌──────────────┬──────────────┬──────────────┬──────────────┐  │
│  │ 微信云函数   │ 微信数据库   │ 微信用户认证 │ 本地存储     │  │
│  │ (Cloud Func) │ (Database)   │ (Auth)       │ (LocalStore) │  │
│  └──────────────┴──────────────┴──────────────┴──────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 模块依赖关系

```
GameScene
  ├─ GameMainManager
  │  ├─ MonsterManager
  │  │  ├─ BaseMonster
  │  │  └─ Castle
  │  ├─ CardManager
  │  │  └─ BaseMonsterCard
  │  ├─ PlayerManager
  │  ├─ EnemyAIManager
  │  ├─ UIManager
  │  └─ SoundManager
  ├─ GameDataManager
  ├─ WeChatManager
  └─ CloudDatabaseManager

MainMenuScene
  ├─ WeChatManager
  ├─ GameDataManager
  ├─ SceneManager
  ├─ SettingPanel
  └─ HelpPanel

LevelSelectScene
  ├─ GameDataManager
  ├─ SceneManager
  └─ LevelLockPanel
```

---

## 业务流程图

### 2.1 游戏启动流程

```
┌─────────────┐
│  游戏启动   │
└──────┬──────┘
       │
       ↓
┌──────────────────────┐
│ 加载启动场景         │
│ (LoadingScreen)      │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 初始化所有管理器     │
│ ├─ WeChatManager     │
│ ├─ GameDataManager   │
│ ├─ CloudResourceLoader
│ └─ SoundManager      │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 预加载所有资源       │
│ ├─ 图片资源          │
│ ├─ 音频资源          │
│ ├─ 预制体            │
│ └─ 场景文件          │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 请求用户授权         │
│ ├─ 获取用户信息      │
│ ├─ 保存到本地        │
│ └─ 同步到云端        │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 进入主菜单场景       │
│ (MainMenuScene)      │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 显示玩家信息         │
│ ├─ 玩家昵称          │
│ ├─ 玩家头像          │
│ └─ 游戏统计          │
└──────────────────────┘
```

### 2.2 游戏战斗流程

```
┌──────────────────────┐
│ 进入游戏场景         │
│ (GameScene)          │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 初始化战场           │
│ ├─ 创建玩家城堡      │
│ ├─ 创建敌方城堡      │
│ ├─ 初始化卡牌手牌    │
│ └─ 初始化法力系统    │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 游戏循环开始         │
│ (每帧更新)           │
└──────┬───────────────┘
       │
       ├─→ ┌──────────────────────┐
       │   │ 更新玩家输入         │
       │   │ ├─ 检测卡牌点击      │
       │   │ ├─ 验证法力充足      │
       │   │ └─ 生成怪物          │
       │   └──────┬───────────────┘
       │          │
       ├─→ ┌──────┴───────────────┐
       │   │ 更新所有怪物         │
       │   │ ├─ 移动              │
       │   │ ├─ 攻击              │
       │   │ └─ 检查死亡          │
       │   └──────┬───────────────┘
       │          │
       ├─→ ┌──────┴───────────────┐
       │   │ 更新AI决策           │
       │   │ ├─ 评估局势          │
       │   │ ├─ 选择卡牌          │
       │   │ └─ 执行出牌          │
       │   └──────┬───────────────┘
       │          │
       ├─→ ┌──────┴───────────────┐
       │   │ 检查胜负条件         │
       │   │ ├─ 玩家城堡血量      │
       │   │ └─ 敌方城堡血量      │
       │   └──────┬───────────────┘
       │          │
       ├─→ ┌──────┴───────────────┐
       │   │ 更新UI显示           │
       │   │ ├─ 血量条            │
       │   │ ├─ 法力值            │
       │   │ └─ 计时器            │
       │   └──────┬───────────────┘
       │          │
       └──────────┘
              │
              ↓ (游戏未结束)
         [继续循环]
              │
              ↓ (游戏结束)
┌──────────────────────┐
│ 游戏结束处理         │
│ ├─ 计算评分          │
│ ├─ 保存数据          │
│ ├─ 显示结果面板      │
│ └─ 返回主菜单        │
└──────────────────────┘
```

### 2.3 卡牌使用流程

```
┌──────────────────────┐
│ 玩家点击卡牌         │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 检查卡牌是否可用     │
│ ├─ 法力是否充足      │
│ ├─ 卡牌是否禁用      │
│ └─ 游戏是否进行中    │
└──────┬───────────────┘
       │
       ├─→ [否] → ┌──────────────────┐
       │          │ 显示错误提示     │
       │          │ 播放错误音效     │
       │          └──────────────────┘
       │
       ├─→ [是]
       │
       ↓
┌──────────────────────┐
│ 消耗法力             │
│ ├─ 减少法力值        │
│ └─ 更新UI            │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 生成怪物             │
│ ├─ 创建怪物实例      │
│ ├─ 设置初始位置      │
│ ├─ 设置初始属性      │
│ └─ 添加到场景        │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 播放生成特效         │
│ ├─ 特效动画          │
│ └─ 音效              │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 更新卡牌状态         │
│ ├─ 禁用卡牌          │
│ ├─ 启动冷却计时器    │
│ └─ 更新卡牌显示      │
└──────────────────────┘
```

### 2.4 怪物攻击流程

```
┌──────────────────────┐
│ 怪物进入攻击范围     │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 检查攻击冷却         │
│ ├─ 是否可以攻击      │
│ └─ 计算攻击间隔      │
└──────┬───────────────┘
       │
       ├─→ [冷却中] → [等待]
       │
       ├─→ [可以攻击]
       │
       ↓
┌──────────────────────┐
│ 计算伤害             │
│ ├─ 基础伤害          │
│ ├─ 等级加成          │
│ ├─ 防御减免          │
│ └─ 最终伤害          │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 目标受伤             │
│ ├─ 减少血量          │
│ ├─ 播放受伤动画      │
│ └─ 播放受伤音效      │
└──────┬───────────────┘
       │
       ↓
┌──────────────────────┐
│ 检查目标是否死亡     │
│ ├─ 血量是否≤0        │
│ └─ 触发死亡流程      │
└──────┬───────────────┘
       │
       ├─→ [未死亡] → [继续战斗]
       │
       ├─→ [已死亡]
       │
       ↓
┌──────────────────────┐
│ 目标死亡处理         │
│ ├─ 播放死亡动画      │
│ ├─ 播放死亡音效      │
│ ├─ 移除尸体          │
│ └─ 更新统计数据      │
└──────────────────────┘
```

---

## 数据流图

### 3.1 用户信息数据流

```
微信用户授权
     │
     ↓
WeChatManager.getUserInfo()
     │
     ├─→ 检查缓存
     │   ├─→ [有缓存] → 返回缓存数据
     │   └─→ [无缓存] → 调用微信API
     │
     ↓
wx.getUserInfo()
     │
     ├─→ [成功]
     │   ├─ 保存到本地存储
     │   ├─ 保存到内存缓存
     │   ├─ 触发更新事件
     │   └─ 返回用户信息
     │
     └─→ [失败]
         └─ 返回错误信息
```

### 3.2 游戏数据同步流程

```
本地游戏数据变化
     │
     ↓
GameDataManager.saveGameData()
     │
     ├─→ 保存到本地存储
     │   └─ Laya.LocalStorage.setItem()
     │
     ├─→ 触发数据同步事件
     │
     ↓
CloudDatabaseManager.saveGameData()
     │
     ├─→ 调用云函数 'updateGameData'
     │
     ↓
微信云开发
     │
     ├─→ 验证数据
     ├─→ 更新数据库
     └─→ 返回结果
     │
     ↓
处理返回结果
     │
     ├─→ [成功]
     │   ├─ 更新本地缓存
     │   └─ 触发同步完成事件
     │
     └─→ [失败]
         └─ 记录错误日志
```

### 3.3 资源加载数据流

```
游戏启动
     │
     ↓
CloudResourceLoader.preloadAllCloudResources()
     │
     ├─→ 获取资源配置列表
     │
     ├─→ 遍历资源列表
     │   │
     │   ├─→ 检查本地缓存
     │   │   ├─→ [有缓存] → 使用缓存
     │   │   └─→ [无缓存] → 下载资源
     │   │
     │   ├─→ 下载资源
     │   │   ├─→ 从CDN下载
     │   │   ├─→ 保存到本地
     │   │   └─ 更新进度
     │   │
     │   └─→ 加载到内存
     │
     ↓
所有资源加载完成
     │
     ├─→ 触发加载完成事件
     └─→ 进入游戏
```

---

## 类关系图

### 4.1 怪物系统类关系

```
┌─────────────────────────────────────┐
│         BaseMonster (抽象类)         │
│  ────────────────────────────────   │
│  - monsterStats: IMonsterStats      │
│  - currentHealth: number            │
│  - currentState: MonsterState       │
│  - currentTarget: BaseMonster|Castle│
│  ────────────────────────────────   │
│  + moveTo(target): void             │
│  + attack(target): void             │
│  + takeDamage(damage): void         │
│  + die(): void                      │
│  + update(deltaTime): void          │
└─────────────────────────────────────┘
         △                △
         │                │
    ┌────┴────┐      ┌────┴────┐
    │          │      │         │
┌───┴──┐  ┌───┴──┐  ┌┴──┐  ┌──┴──┐
│ Rock │  │Sword │  │...│  │Human│
│Monster│  │Monster│  │   │  │Type │
└──────┘  └──────┘  └───┘  └─────┘

┌─────────────────────────────────────┐
│         Castle (城堡类)              │
│  ────────────────────────────────   │
│  - maxHealth: number                │
│  - currentHealth: number            │
│  - isPlayerCastle: boolean          │
│  ────────────────────────────────   │
│  + takeDamage(damage): void         │
│  + getHealth(): number              │
│  + isDestroyed(): boolean           │
└─────────────────────────────────────┘
```

### 4.2 卡牌系统类关系

```
┌─────────────────────────────────────┐
│    BaseMonsterCard (抽象类)          │
│  ────────────────────────────────   │
│  - cardName: string                 │
│  - manaCost: number                 │
│  - monsterLevel: number             │
│  - isPlayerCard: boolean            │
│  - monsterPrefabPath: string        │
│  ────────────────────────────────   │
│  + onCardClick(): void              │
│  + useCard(): void                  │
│  + updateCardLabels(): void         │
│  + isEnabled(): boolean             │
└─────────────────────────────────────┘
         △
         │
    ┌────┴────┬────────┬────────┐
    │          │        │        │
┌───┴──┐  ┌───┴──┐  ┌──┴──┐  ┌─┴───┐
│ Rock │  │Sword │  │Archer│  │...  │
│ Card │  │ Card │  │ Card │  │     │
└──────┘  └──────┘  └──────┘  └─────┘

┌─────────────────────────────────────┐
│      CardManager (管理器)            │
│  ────────────────────────────────   │
│  - playerCards: BaseMonsterCard[]   │
│  - enemyCards: BaseMonsterCard[]    │
│  ────────────────────────────────   │
│  + getPlayerCards(): BaseMonsterCard│
│  + getEnemyCards(): BaseMonsterCard │
│  + playCard(card): void             │
│  + updateCardStates(): void         │
└─────────────────────────────────────┘
```

### 4.3 管理器类关系

```
┌──────────────────────────────────────┐
│      GameMainManager (主管理器)       │
│  ──────────────────────────────────  │
│  - monsterManager: MonsterManager    │
│  - cardManager: CardManager          │
│  - playerManager: PlayerManager      │
│  - enemyAIManager: EnemyAIManager    │
│  - uiManager: UIManager              │
│  ──────────────────────────────────  │
│  + getInstance(): GameMainManager    │
│  + initializeGame(): void            │
│  + startGameLoop(): void             │
│  + endGame(winner): void             │
└──────────────────────────────────────┘
         │
    ┌────┼────┬────────┬────────┐
    │    │    │        │        │
    ↓    ↓    ↓        ↓        ↓
┌──────┐┌──────┐┌──────┐┌──────┐┌──────┐
│Monster││Card ││Player││Enemy ││ UI   │
│Manager││Manager││Manager││AIManager││Manager│
└──────┘└──────┘└──────┘└──────┘└──────┘
```

---

## 状态转移图

### 5.1 怪物状态转移

```
        ┌─────────────────────────────────────┐
        │                                     │
        ↓                                     │
    ┌────────┐                                │
    │  IDLE  │ (待机)                         │
    └────┬───┘                                │
         │ 发现目标                           │
         ↓                                    │
    ┌────────┐                                │
    │ MOVING │ (移动中)                       │
    └────┬───┘                                │
         │ 进入攻击范围                       │
         ↓                                    │
    ┌────────────┐                            │
    │ ATTACKING  │ (攻击中)                   │
    └────┬───────┘                            │
         │ 目标死亡/超出范围                  │
         ↓                                    │
    ┌────────┐                                │
    │ DYING  │ (死亡中)                       │
    └────┬───┘                                │
         │ 死亡动画完成                       │
         ↓                                    │
    ┌────────┐                                │
    │  DEAD  │ (已死亡)                       │
    └────────┘                                │
         │                                    │
         └────────────────────────────────────┘
              (移除尸体)
```

### 5.2 游戏状态转移

```
    ┌──────────────┐
    │ LOADING      │ (加载中)
    │ (加载屏幕)   │
    └──────┬───────┘
           │ 资源加载完成
           ↓
    ┌──────────────┐
    │ MAIN_MENU    │ (主菜单)
    └──────┬───────┘
           │ 点击开始游戏
           ↓
    ┌──────────────┐
    │ LEVEL_SELECT │ (关卡选择)
    └──────┬───────┘
           │ 选择关卡
           ↓
    ┌──────────────┐
    │ GAME_PLAYING │ (游戏进行中)
    └──────┬───────┘
           │ 游戏结束
           ↓
    ┌──────────────┐
    │ GAME_END     │ (游戏结束)
    └──────┬───────┘
           │ 返回主菜单
           ↓
    ┌──────────────┐
    │ MAIN_MENU    │ (主菜单)
    └──────────────┘
```

### 5.3 卡牌状态转移

```
    ┌──────────────┐
    │ AVAILABLE    │ (可用)
    │ (法力充足)   │
    └──────┬───────┘
           │ 点击卡牌
           ↓
    ┌──────────────┐
    │ USING        │ (使用中)
    │ (消耗法力)   │
    └──────┬───────┘
           │ 生成怪物
           ↓
    ┌──────────────┐
    │ COOLDOWN     │ (冷却中)
    │ (等待冷却)   │
    └──────┬───────┘
           │ 冷却完成
           ↓
    ┌──────────────┐
    │ AVAILABLE    │ (可用)
    └──────────────┘

    ┌──────────────┐
    │ DISABLED     │ (禁用)
    │ (法力不足)   │
    └──────┬───────┘
           │ 法力恢复
           ↓
    ┌──────────────┐
    │ AVAILABLE    │ (可用)
    └──────────────┘
```

---

## 总结

本文档通过流程图、架构图、数据流图、类关系图和状态转移图，详细展示了《石头人保卫战》微信小游戏的系统设计和运行机制。这些图表为软件著作权申请提供了清晰的技术文档支持。

**关键设计特点：**

1. **分层架构**：清晰的UI层、业务逻辑层、数据管理层和外部服务层划分
2. **模块化设计**：各个功能模块相对独立，便于维护和扩展
3. **单例模式**：所有管理器采用单例模式，确保全局唯一性
4. **事件驱动**：使用事件系统实现模块间的通信
5. **状态机**：使用状态机管理怪物、游戏和卡牌的状态转移
6. **异步处理**：使用Promise和async/await处理异步操作

---

*本文档为软件著作权申请的鉴别材料，详细描述了系统的架构设计和业务流程。*

